<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2D Traffic Racer - Shift Boost & Fix Restart</title>
<style>
  body, html {
    margin: 0; padding: 0; overflow: hidden; background: #0f0f0f;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  canvas {
    display: block; background: #1e1e1e; margin: 0 auto;
  }
  #ui, #highscore {
    position: absolute;
    left: 20px;
    color: white;
    font-size: 18px;
    user-select: none;
    z-index: 10;
    background: rgba(20, 20, 20, 0.6);
    padding: 8px 12px;
    border-radius: 10px;
    backdrop-filter: blur(4px);
  }
  #ui {
    top: 10px;
  }
  #highscore {
    top: 50px;
    color: #00ff99;
  }
  #instructions {
    position: absolute;
    top: 10px;
    right: 20px;
    color: #ddd;
    font-size: 14px;
    line-height: 1.6;
    background: rgba(0,0,0,0.5);
    padding: 12px 16px;
    border-radius: 12px;
    max-width: 220px;
    user-select: none;
    z-index: 10;
    box-shadow: 0 0 10px rgba(0,0,0,0.4);
    backdrop-filter: blur(4px);
  }
  #instructions p {
    margin: 0 0 6px;
  }
  #menu {
    position: absolute;
    top: 100px;
    left: 20px;
    user-select: none;
    z-index: 10;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  #menu button {
    padding: 10px 20px;
    font-size: 15px;
    cursor: pointer;
    border-radius: 8px;
    border: none;
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    transition: transform 0.2s, background 0.3s;
  }
  #menu button:hover {
    background: linear-gradient(135deg, #0056b3, #003f7f);
    transform: translateY(-2px);
  }
  #overlay {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    color: white; font-size: 24px;
    user-select: none; z-index: 20;
    text-align: center;
    padding: 20px;
  }
  #overlay h1 {
    font-size: 44px;
    margin-bottom: 20px;
  }
  #overlay button {
    margin-top: 20px;
    padding: 14px 28px;
    font-size: 20px;
    border: none;
    border-radius: 8px;
    background: linear-gradient(135deg, #00cc66, #00994d);
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    transition: background 0.3s, transform 0.2s;
  }
  #overlay button:hover {
    background: linear-gradient(135deg, #00a653, #007f3a);
    transform: translateY(-2px);
  }
</style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="ui">Score: <span id="score">0</span></div>
  <div id="highscore">Highscore: <span id="highscore-val">0</span></div>

  <div id="instructions">
    <p><b>Shift</b>: Boost (NOS)</p>
    <p><b>A / D</b> or <b>← / →</b>: Move Left / Right</p>
    <p>Try to overtake traffic and avoid collision!</p>
  </div>

  <div id="menu">
    <button id="btnPause">Pause</button>
    <button id="btnPlay" style="display:none;">Play</button>
    <button id="btnRestart">Restart</button>
  </div>

  <div id="overlay" style="display:none;">
    <h1>2D Traffic Racer</h1>
    <p id="overlay-score"></p>
    <button id="overlayRestartBtn">Restart</button>
  </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let W, H;
let animationFrameId = null;

function resize() {
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

const laneWidth = 80;
let roadMargin;

const player = {
  x: 0,
  y: 0,
  width: 50,
  height: 100,
  speedX: 0,
  maxSpeedX: 10,
  color: '#00aaff'
};

let enemies = [];
let keys = {};
let boosting = false;
let score = 0;
let highscore = 0;
let gameOverFlag = false;
let laneOffset = 0;
let paused = false;

const scoreEl = document.getElementById('score');
const highscoreEl = document.getElementById('highscore-val');
const overlay = document.getElementById('overlay');
const overlayScore = document.getElementById('overlay-score');
const btnPause = document.getElementById('btnPause');
const btnPlay = document.getElementById('btnPlay');
const btnRestart = document.getElementById('btnRestart');
const overlayRestartBtn = document.getElementById('overlayRestartBtn');

function randomPastelColor() {
  const r = Math.floor(Math.random() * 127 + 128);
  const g = Math.floor(Math.random() * 127 + 128);
  const b = Math.floor(Math.random() * 127 + 128);
  return `rgb(${r},${g},${b})`;
}
function drawVehicle(x, y, width, height, color, type = 'car') {
  ctx.save();

  // Flip vertical so car faces upwards (normal road direction)
  ctx.translate(x + width / 2, y + height / 2);
  ctx.scale(1, -1);
  ctx.translate(-(x + width / 2), -(y + height / 2));

  ctx.fillStyle = color;
  ctx.strokeStyle = '#000';
  ctx.lineWidth = 2;
  ctx.fillRect(x, y, width, height);
  ctx.strokeRect(x, y, width, height);

  ctx.fillStyle = '#77ccff';
  ctx.beginPath();
  ctx.moveTo(x + width * 0.2, y + height * 0.1);
  ctx.lineTo(x + width * 0.8, y + height * 0.1);
  ctx.lineTo(x + width * 0.7, y + height * 0.4);
  ctx.lineTo(x + width * 0.3, y + height * 0.4);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  ctx.fillStyle = '#222';
  let wheelHeight = height * 0.1;
  let wheelWidth = width * 0.15;
  if (type === 'truck') {
    wheelHeight = height * 0.12;
    wheelWidth = width * 0.2;
  }
  ctx.beginPath();
  ctx.ellipse(x + width * 0.25, y + height * 0.85, wheelWidth, wheelHeight, 0, 0, 2 * Math.PI);
  ctx.ellipse(x + width * 0.75, y + height * 0.85, wheelWidth, wheelHeight, 0, 0, 2 * Math.PI);
  ctx.fill();

  ctx.restore();
}

function canSpawnAt(x, y, width, height){
  const minDistanceY = 200;
  for(let enemy of enemies){
    let dx = Math.abs(enemy.x - x);
    let dy = Math.abs(enemy.y - y);
    if(dx < width && dy < minDistanceY){
      return false;
    }
  }
  return true;
}

function spawnEnemy(){
  if(enemies.length >= 4) return;

  const types = ['car', 'car', 'car', 'truck'];
  const type = types[Math.floor(Math.random()*types.length)];

  let width = type === 'truck' ? 70 : 50;
  let height = type === 'truck' ? 160 : 100;

  const emptyLane = Math.floor(Math.random() * 5);

  let tries = 0;
  while(tries < 15){
    let laneIndex = Math.floor(Math.random() * 5);

    if(laneIndex === emptyLane){
      tries++;
      continue;
    }

    let x = roadMargin + laneIndex*laneWidth + laneWidth/2 - width/2;
    x += (Math.random()*20) - 10;

    let y = -height - Math.random()*300;

    if(canSpawnAt(x, y, width, height)){
      enemies.push({x, y, width, height, color: randomPastelColor(), type});
      break;
    }
    tries++;
  }
}

function isColliding(a,b){
  return !(a.x > b.x + b.width ||
           a.x + a.width < b.x ||
           a.y > b.y + b.height ||
           a.y + a.height < b.y);
}

function drawRoad(){
  ctx.fillStyle = '#222';
  ctx.fillRect(0,0,W,H);

  roadMargin = (W - laneWidth * 5) / 2;

  ctx.fillStyle = '#666';
  ctx.fillRect(0,0,roadMargin,H);
  ctx.fillRect(W-roadMargin,0,roadMargin,H);

  ctx.strokeStyle = 'white';
  ctx.lineWidth = 4;
  ctx.setLineDash([30, 30]);
  for(let i=1;i<5;i++){
    let x = roadMargin + i*laneWidth;
    ctx.beginPath();
    for(let y = -30 + laneOffset; y < H; y += 60){
      ctx.moveTo(x, y);
      ctx.lineTo(x, y + 30);
    }
    ctx.stroke();
  }
  ctx.setLineDash([]);
}

function draw(){
  drawRoad();

  drawVehicle(player.x, player.y, player.width, player.height, player.color, 'car');

  enemies.forEach(enemy=>{
    drawVehicle(enemy.x, enemy.y, enemy.width, enemy.height, enemy.color, enemy.type);
  });
}

function update(){
  if(gameOverFlag || paused) return;

  laneOffset += 10 + (boosting ? 10 : 0);
  if(laneOffset >= 60) laneOffset = 0;

  if(keys['arrowleft'] || keys['a']){
    player.speedX -= 1;
  }
  if(keys['arrowright'] || keys['d']){
    player.speedX += 1;
  }
  if(!(keys['arrowleft'] || keys['a'] || keys['arrowright'] || keys['d'])){
    player.speedX *= 0.8;
  }

  if(player.speedX > player.maxSpeedX) player.speedX = player.maxSpeedX;
  if(player.speedX < -player.maxSpeedX) player.speedX = -player.maxSpeedX;

  player.x += player.speedX;
  if(player.x < roadMargin) player.x = roadMargin;
  if(player.x + player.width > W - roadMargin) player.x = W - roadMargin - player.width;

  let enemySpeed = 5 + (boosting ? 5 : 0);

  for(let i=enemies.length-1; i>=0; i--){
    enemies[i].y += enemySpeed;
    if(enemies[i].y > H) enemies.splice(i,1);
  }

  if(Math.random() < 0.02) spawnEnemy();

  for(let enemy of enemies){
    if(isColliding(player, enemy)){
      endGame();
      break;
    }
  }

  score++;
  scoreEl.textContent = score;

  if(score > highscore){
    highscore = score;
    highscoreEl.textContent = highscore;
  }

  draw();

  animationFrameId = requestAnimationFrame(update);
}

function startGame(){
  if(animationFrameId) cancelAnimationFrame(animationFrameId);
  animationFrameId = null;

  roadMargin = (W - laneWidth * 5) / 2;
  player.x = roadMargin + laneWidth*2 + laneWidth/2 - player.width/2;
  player.y = H - 150;
  player.speedX = 0;
  enemies = [];
  score = 0;
  gameOverFlag = false;
  boosting = false;
  laneOffset = 0;
  paused = false;
  player.color = randomPastelColor();
  scoreEl.textContent = score;
  overlay.style.display = 'none';
  btnPlay.style.display = 'none';
  btnPause.style.display = 'inline-block';

  update();
}

function endGame(){
  gameOverFlag = true;
  overlay.style.display = 'flex';
  overlayScore.textContent = `Score: ${score}\nHighscore: ${highscore}`;
  btnPlay.style.display = 'none';
  btnPause.style.display = 'none';
  if(animationFrameId) {
    cancelAnimationFrame(animationFrameId);
    animationFrameId = null;
  }
}

function pauseGame(){
  paused = true;
  btnPause.style.display = 'none';
  btnPlay.style.display = 'inline-block';
  if(animationFrameId) {
    cancelAnimationFrame(animationFrameId);
    animationFrameId = null;
  }
}

function resumeGame(){
  if(!gameOverFlag){
    paused = false;
    btnPlay.style.display = 'none';
    btnPause.style.display = 'inline-block';
    if(!animationFrameId) update();
  }
}

btnPause.addEventListener('click', pauseGame);
btnPlay.addEventListener('click', resumeGame);
btnRestart.addEventListener('click', () => {
  if(!gameOverFlag){
    startGame();
  }
});

overlayRestartBtn.addEventListener('click', () => {
  overlay.style.display = 'none';
  startGame();
});

window.addEventListener('keydown', e=>{
  keys[e.key.toLowerCase()] = true;
  if(e.key === 'Shift') boosting = true;
});
window.addEventListener('keyup', e=>{
  keys[e.key.toLowerCase()] = false;
  if(e.key === 'Shift') boosting = false;
});

startGame();
</script>
</body>
</html>
